@model F.FINANCIAMIENTO.DTO.INSERTDTO

@{
    ViewBag.Title = "Index";
}
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

<div class="panel-heading">
    &nbsp;
</div>
<div class="panel panel-default">

    @using (Html.BeginForm("GetData", "Home", FormMethod.Get, new { id = "form" }))
    {
        <div class="form-horizontal panel-body">
            <br />
            <div class="row">
                <div class="form-group col-lg-12">
                    <div class="col-sm-3">
                        <label> GRUPO </label>
                        @Html.DropDownList("dd",(IEnumerable<SelectListItem>)ViewBag.Grupos, new { id = "ddGrupos", @class = "form-control" })
                    </div>

                    <div class="col-sm-3">
                        @Html.Label("VIGENTE", htmlAttributes: new { @class = "control-label" })<br />
                        <input type="checkbox" name="ckbVigente" id="ckbVigente" checked="checked" />
                    </div>
                </div>

            </div>
            <div class="row">
                <div class="form-group col-lg-12">
                    <div class="col-sm-3">
                        <label>SUB-GRUPO</label>
                        <input name="txtSubG" id="txtSubG" type="number" class="form-control" placeholder="0" />
                    </div>
                    <div class="col-sm-3">
                        <label>DESCRIPCIÓN</label>
                        @Html.TextBox("txtSubDesc", "", new { id = "txtSubDesc", type = "text", @class = "form-control" })
                    </div>
                </div>
            </div>
            <div id="clsOk"></div>
        </div>

    <div id="contentLst">
        <div class="panel panel-default">
            <div class="panel-heading">
                <button id="addBtn" type="button" class="glyphicon glyphicon-plus btn btn-info pull-right" onclick="Agregar()"></button>
                <span>&nbsp;</span>
            </div>
            <div class="ChkBrOnly">
                <div class="panel-body">
                    <div class="form-group">
                        <table id="tblPerfGrup" class="table table-bordered table-responsive">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>FUENTE</th>
                                    <th>VIGENTE</th>
                                    <th>DESC</th>
                                    <th></th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="pFooter" class="panel-footer">
        <div id="pBodyFooter" class="panel-body" style="padding:0px;">
            <button id="btnGuardar" type="button" class="glyphicon glyphicon-save btn btn-success btn-lg pull-left"  onclick="Guardar()"></button>
        </div>
    </div>
    }
</div>

<style>
       .ChkBrOnly input[type="checkbox"][readonly] {
        pointer-events: none;
    }
</style>

    <script>
        $(document).ready(function () {
            $("#clsOk").slideUp("slow");
            //$("#pFooter").slideUp("slow");
        });

        var data = [];
        var selectDataIndex;
        var indexAllowed;
        var btnPressed = 0;

        function Guardar() {
            if(data.length <= 0)
            {
                alert("No hay datos en la lista");
            }
            else
            {
                document.getElementById("form").submit();
            }
        };

        function Agregar() {
            if (!btnPressed == 1) {
                var isChecked;
                if ($('#ckbVigente').is(":checked")) {
                    isChecked = "checked";
                } else {
                    isChecked = "";
                }


                var grupo = $('#ddGrupos').val();
                var fFinanciamientoId = grupo + $('#txtSubG').val();

                if ($('#ckbVigente').val() == "") {
                    LobiboxAlert('warning', 'Precaución', 'Seleccione un Perfil.');
                }
                else {
                    cargaDetalle(isChecked, fFinanciamientoId, $('#ddGrupos').val(), $('#txtSubG').val());
                    imprimir();
                    $('.ddGrupos-DropDownCls option').eq(0).prop('selected', true);
                }
            }
            else {
                alert("Esta en modo edición")
            }
        };

        function cargaDetalle(isChecked,fFinanciamientoId, grupo,sGrupo) {
            
           
            Desc_Perfil = $('#txtSubDesc').val();
         

            var ExisteRestriccion = false;
            $.each(data, function (i, item) {
                if (item.Perfil == fFinanciamientoId) {
                    ExisteRestriccion = true;
                }
            });

            
            if ($.isEmptyObject(data) || ExisteRestriccion == false) {
                data.push({

                    grupoId: grupo,
                    sGrupoTxt: sGrupo,
                    boton2: "<button class='btn-info'></button>",
                    Perfil: fFinanciamientoId,
                    Desc_Perf: Desc_Perfil,
                    Grupo:isChecked,
                    boton: "<button class='deleteButton' onclick='deleteButtonClick()'>Eliminar</button>",
                    items: []
                });
            }
            else
            {
                alert('Precaución, '+'la restricción ya esxiste.');
            }
        };

        function imprimir() {
            $('#tbTabla').remove();
            if (!$.isEmptyObject(data)) {
                document.getElementById("tblPerfGrup").appendChild(ToTable(data));
            }
            $('#txtSubG').val("");
            $('#txtSubDesc').val("");
        };

        function ToTable(tblData) {
            var table2 = document.createElement("tbody");
            table2.id = "tbTabla";
            table2.className = "table";
            for (var x = 0; x < tblData.length; x++) {
                var row = document.createElement("tr");
            
                //
                var IdPerfCell = document.createElement("td");
                IdPerfCell.width = "150px";
                //
                //
                var DescPerfCell = document.createElement("td");
                DescPerfCell.width = "800px";
                //
                var IdGrupoCell = document.createElement("td");
                var DescGrupoCell = document.createElement("td");
                

                var deleteButtonRestrriccionCell = document.createElement("td");
                deleteButtonRestrriccionCell.width = "1%";
                deleteButtonRestrriccionCell.style = "padding: 0px;";
                var deleteButtonRestriccion = document.createElement("button");
                var iconButtonRestriccion = document.createElement("i");
                var att = document.createAttribute("aria-hidden");
                att.value = true;
                iconButtonRestriccion.setAttributeNode(att);
                iconButtonRestriccion.className = "fa fa-times";
                deleteButtonRestriccion.className = "btn btn-danger";
                deleteButtonRestriccion.style = "width:100%";
                //-----------------------------------------------------Boton Edit Original
                //var editButtonRestrriccionCell = document.createElement("td");
                //editButtonRestrriccionCell.width = "1%";
                //var editButtonRestriccion = document.createElement("input");
                //var editIconButtonRestriccion = document.createElement("i");
                //var attEdit = document.createAttribute("aria-hidden");
                //attEdit.value = true;
                //editIconButtonRestriccion.setAttributeNode(attEdit);
                //editIconButtonRestriccion.className = "fa fa-pencil-square-o";
                //editButtonRestriccion.type = "button";
                //editButtonRestriccion.className = "glyphicon glyphicon-edit btn btn-info";
                //editButtonRestriccion.style = "width:100%";

                //
                var editButtonRestrriccionCell = document.createElement("td");
                editButtonRestrriccionCell.width = "1px";
                editButtonRestrriccionCell.style = "padding: 0px;";
                //var editButtonRestriccion = '<button id="btnGuardar" type="button" class="glyphicon glyphicon-edit btn btn-info" style="width: 100%;"></button>';
                editButtonRestrriccionCell.innerHTML = '<button id="btnGuardar" type="button" class="glyphicon glyphicon-edit btn btn-info" style="width:37px; height:34px; display:block; "></button>';
                //-----------------------------------------------------
                var createCheckboxCell = document.createElement("td");
                createCheckboxCell.width = "1px";
                createCheckboxCell.style = "padding: 0px; text-align: center; vertical-align: middle;";
                var createCheckbox = document.createElement('input');
                createCheckbox.type = 'checkbox';
                createCheckbox.checked = tblData[x].Grupo;
                createCheckbox.setAttribute("readonly",null);
                createCheckbox.style = 'width:37px; height:25px;';


                //-----------------------------------------------------
                var txtIdGrupo = "FuenteFin[" + x + "].ID_GRUPO";
                //var IdGrupo = "Perfiles_Grupos_" + x + "__ID_GRUPO";
                var txtFuenteFin = "FuenteFin[" + x + "].FUENTE_FINANCIAMIENTO";
                //var idNgrupo = "Perfiles_Grupos_" + x + "__NOMBRE_PERFIL";
                var txtVigente = "FuenteFin[" + x + "].VIGENTE";
                //var idNperfil = "Perfiles_Grupos_" + x + "__NOMBRE_PERFIL";
                var txtDesc = "FuenteFin[" + x + "].DESC";
                //var IdPerfil = "Perfiles_Grupos_" + x + "__ID_PERFIL";

              

                var inputGrupo = document.createElement("input");
                inputGrupo.id = txtIdGrupo;
                inputGrupo.name = txtIdGrupo;
                inputGrupo.value = tblData[x].grupoId;
                inputGrupo.type = "Hidden";

                var inputFuenteFin = document.createElement("input");
                inputFuenteFin.id = txtFuenteFin;
                inputFuenteFin.name = txtFuenteFin;
                inputFuenteFin.value = tblData[x].Perfil;
                inputFuenteFin.type = "Hidden";

                var inputVigente = document.createElement("input");
                inputVigente.id = txtVigente;
                inputVigente.name = txtVigente;
                inputVigente.value = tblData[x].Grupo;
                inputVigente.type = "Hidden";

                var inputDesc = document.createElement("input");
                inputDesc.id = txtDesc;
                inputDesc.name = txtDesc;
                inputDesc.value = tblData[x].Desc_Perf;
                inputDesc.type = "Hidden";




                var _Perf = tblData[x].Perfil;
                var _Grup = tblData[x].Grupo;
                //---------------------------------------------------------------
                deleteButtonRestriccion.addEventListener("click", callDelete( _Perf, _Grup));
                editButtonRestrriccionCell.addEventListener("click", callEdit(_Perf, _Grup));
                deleteButtonRestriccion.appendChild(iconButtonRestriccion);
                //editButtonRestriccion.appendChild(editIconButtonRestriccion);
                //----------------------------------------------------------------
                IdPerfCell.innerText = tblData[x].Perfil;
                DescPerfCell.innerText = tblData[x].Desc_Perf;
                IdGrupoCell.innerText = tblData[x].Grupo;
                DescGrupoCell.innerText = tblData[x].Desc_Grup;
                //-----------------------------------------------------------------
                deleteButtonRestrriccionCell.appendChild(deleteButtonRestriccion);
                //editButtonRestrriccionCell.appendChild(editButtonRestriccion);
                createCheckboxCell.appendChild(createCheckbox);
                //------------------------------------------------------------------
                row.appendChild(editButtonRestrriccionCell);
                row.appendChild(IdPerfCell);

                //idgrupo/Fuentefin
                row.appendChild(inputGrupo);
                row.appendChild(inputFuenteFin);
                //

                row.appendChild(createCheckboxCell);

                //Vigente
                row.appendChild(inputVigente);
                //

                row.appendChild(DescPerfCell);

                //Desc
                row.appendChild(inputDesc);
                //

                row.appendChild(deleteButtonRestrriccionCell);
          

                table2.appendChild(row);
            }
            return table2;
        }

        function callDelete(Perfil, Grupo)
        {
            return function () {
                deleteButtonClick(Perfil, Grupo);
            };
        }
        //----------------------------------------------------------------
        function callEdit(Perfil, Grupo)
        {
            return function () {
                editButtonClick(Perfil, Grupo);
            };
        }
        //----------------------------------------------------------------

        function deleteButtonClick(Perfil, Grupo) {
            if (!btnPressed == 1) {
                for (var i = 0; i < data.length; i++) {
                    if (data[i].Perfil == Perfil && data[i].Grupo == Grupo) {
                        data.splice(i, 1);
                    }
                }
                imprimir();
            }
            else {
                alert("Esta en modo edición");
            }
        }
        //-----------------------------------------------------------------
        function editButtonClick(Perfil, Grupo) {
            for (var i = 0; i < data.length; i++) {
                if (data[i].Perfil == Perfil && data[i].Grupo == Grupo) {
                    debugger
                    selectDataIndex = i;
                    indexAllowed = data[i].Perfil;
                    var ddSelected = data[i].grupoId;
                    $("#ddGrupos").val(ddSelected);
                    var txtSubVal = data[i].sGrupoTxt;
                    $("#txtSubG").val(txtSubVal);
                    $("#txtSubDesc").val(data[i].Desc_Perf);
                    var checked = data[i].Grupo;

                    if (checked != "checked") {
                        $("#ckbVigente").removeAttr("checked");
                    }

                    if (checked == "checked") {
                        $("#ckbVigente").prop("checked",true);
                    }

                    document.getElementById("txtSubG").focus();
                    if (btnPressed == 0) {
                        $('#clsOk').append('<button id="btnOk" type="button" class="glyphicon glyphicon-ok btn btn-success pull-left" onclick="Editar()"></button>');
                        $("#clsOk").slideDown("slow");
                        btnPressed = 1;
                    }

                }

            }
        }

        function Editar() {
            debugger


            var isChecked;
            if ($('#ckbVigente').is(":checked")) {
                isChecked = "checked";
            } else {
                isChecked = "";
            }
            var grupo = $('#ddGrupos').val();
            var fFinanciamientoId = grupo + $('#txtSubG').val();

            if ($('#ckbVigente').val() == "") {
                LobiboxAlert('warning', 'Precaución', 'Seleccione un Perfil.');
            }
            else {
                cargaDetalleEditado(isChecked, fFinanciamientoId, $('#ddGrupos').val(), $('#txtSubG').val());
                $('.ddGrupos-DropDownCls option').eq(0).prop('selected', true);
            }
        }

        function cargaDetalleEditado(isChecked, fFinanciamientoId, grupo,sGrupo) {
            Desc_Perfil = $('#txtSubDesc').val();

            var ExisteRestriccion = false;
            $.each(data, function (i, item) {
                if (item.Perfil == fFinanciamientoId) {
                    ExisteRestriccion = true;
                }
            });

            debugger
            if (indexAllowed == fFinanciamientoId) {
                ExisteRestriccion = false;
            }
            if ($.isEmptyObject(data) || ExisteRestriccion == false) {
                    data[selectDataIndex].grupoId = grupo,
                    data[selectDataIndex].sGrupoTxt = sGrupo,
                    data[selectDataIndex].boton2 = "<button class='btn-info'></button>";
                    data[selectDataIndex].Perfil = fFinanciamientoId;
                    data[selectDataIndex].Desc_Perf = Desc_Perfil;
                    data[selectDataIndex].Grupo = isChecked;
                    data[selectDataIndex].boton = "<button class='deleteButton' onclick='deleteButtonClick()'>Eliminar</button>";
                    $("#clsOk").slideUp("slow");
                    $('#btnOk').remove();
                    btnPressed = 0;
                    imprimir();
                }
                else {
                alert('Precaución, ' + 'la restricción ya existe.');
                }
        };




    </script>
